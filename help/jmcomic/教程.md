## JM 插件使用说明

## 快速部署 QQBot（NapCat + NoneBot）

### 准备
- 克隆项目并安装依赖  
- python版本为3.11
  ```bash
  git clone https://github.com/HugTibers/qqbot-jm-Napcat-Nonebot.git
  cd qqbot-jm-Napcat-Nonebot
  pip install -r requirements.txt
  ```

### 安装 NapCat（Shell/Rootless）
执行安装脚本：
```bash
curl -o napcat.sh https://nclatest.znin.net/NapNeko/NapCat-Installer/main/script/install.sh && bash napcat.sh
```
- 安装方式选 Shell：输入 `n`
- 是否安装 NapCat TUI-CLI：建议 `y`

### 配置 NapCat
1) 终端运行 `napcat` 打开 NapCat Shell。  
2) 添加账号并扫码登录。  
![配置 Napcat](./配置Napcat.png)  
3) 配置 WebSocket 反向客户端：  
   - URL：`ws://127.0.0.1:8082/onebot/v11/ws`  
   - Token：自行设置（需与 `.env` 的 `ONEBOT_ACCESS_TOKEN` 一致）  
   - 消息格式：数组  
   - 启用服务  
  ![客户端设置](./客户端设置.png)

4) 配置WebUI
   - 这里的Token是用来登陆网页端的
   - 下一步用这里的Token登陆网页
  ![WebUI](./WebUI.png)
截图参考：  

### 获取IP
有服务器的就用公网ip,我现在用的WSL测试
运行 `ifconfig` 查看 `eth0` 的 `inet`，如示例 `172.21.127.64`。  
![IP](./ip.png)

### 打开 WebUI
浏览器访问 `http://<WSL_IP>:6099/webui`，使用刚才设置的 token 登录。  
![WebUI](./网页.png)

### 验证 OneBot 反向 WS 配置
确认 WebSocket 客户端已连接，token 与 `.env` 保持一致。  
![WebSocket 客户端](./WebSocket客户端.png)

### 启动并测试机器人
```bash
python bot.py
```
看到 Uvicorn/NoneBot 正常日志即已运行。  
在群内 @机器人 发送 `jmhelp` 测试。 **(此为旧版 新版不再需要@ 直接发送指令就行)**
![启动成功](./启动成功.png)  
![测试](./测试.png)

## 使用 systemd 常驻运行（示例）
创建 `/etc/systemd/system/qqbot.service`（路径按需调整）：
```ini
[Unit]
Description=QQBot (NapCat + NoneBot)
After=network.target

[Service]
Type=simple
User=<your_user>
WorkingDirectory=/path/to/qqbot
Environment="PATH=/path/to/qqbot/.venv/bin:/usr/bin" 
ExecStart=/path/to/qqbot/.venv/bin/python bot.py
Restart=on-failure

[Install]
WantedBy=multi-user.target
```
命令参考：
```bash
sudo systemctl daemon-reload
sudo systemctl enable qqbot.service
sudo systemctl start qqbot.service
sudo journalctl -fu qqbot.service  # 查看日志
```

### 指令
- `jm<id>`：下载漫画并发送 PDF（示例：`jm123456`）。
- `jm队列` / `jmqueue`：查看当前下载中 / 排队任务。
- `jm取消<id>` / `jm删除<id>`：取消等待队列中的指定漫画。
- `jmhelp` / `jm帮助`：查看帮助。
- `jmstart` / `jmstop`：开启/关闭插件。

### 特性
- **权限**：
  - `ALLOWED_GROUPS` 为空时不限制群，填入群号集合则仅允许特定群。
- **上传**：
  - 上传超时自适应（文件越大超时越长，最高 300s）。
  - 遇到 `rich media transfer failed` / `retcode=1200` （大概率风控） 自动重传
  - 可能的上传超时会提示"上传耗时较长"。
- **清理**：上传后延迟删除下载目录（默认 `CLEANUP_DELAY_SECONDS=86400` 秒）。
- **存储**：默认下载路径按专辑ID分隔（`option.yml` 中 `rule: Bd / Aid / Ptitle`），避免不同漫画章节同名时被混合。

### 主要配置（`plugins/jmcomic/service.py`）
- `ALLOWED_GROUPS`: `{}` 表示不限制群；填 `{123456789, ...}` 仅允许特定群。
- `CLEANUP_DELAY_SECONDS`: 上传后延迟清理秒数，默认 `86400`。
- `MAX_CONCURRENT`: 同时下载/上传任务数上限，默认 `2`。
- `API_TIMEOUT`: 短接口默认超时（秒），默认 `20`。

---

## 群
 967864538